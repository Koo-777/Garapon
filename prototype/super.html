<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ã‚¬ãƒ©ã‚¬ãƒ©ãƒãƒ³</title>
    <style>
        :root { --machine-color: #f1c40f; --bg-color: #f0f8ff; }
        body { display: flex; flex-direction: column; align-items: center; background-color: var(--bg-color); font-family: sans-serif; padding: 20px; }
        .main-layout { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; max-width: 1100px; }
        
        /* æŠ½é¸æ©Ÿ */
        .machine-area { text-align: center; width: 320px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .machine-container { position: relative; width: 200px; height: 220px; margin: 20px auto; }
        .machine-body { width: 150px; height: 150px; background-color: var(--machine-color); border: 5px solid #333; border-radius: 30px; position: relative; margin: 0 auto; z-index: 2; }
        .rotating { animation: spin 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(720deg); } }
        .exit { position: absolute; bottom: 40px; right: 10px; width: 40px; height: 20px; background: #95a5a6; border: 3px solid #333; border-radius: 5px; z-index: 1; }
        .ball { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; position: absolute; bottom: 40px; right: 15px; opacity: 0; z-index: 0; }
        .ball-drop { animation: drop 0.6s forwards; }
        @keyframes drop { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(70px) translateX(50px); opacity: 1; } }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 450px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        input { padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="number"] { width: 45px; }

        .btn { padding: 8px 15px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-add { background: #2ecc71; color: white; }
        .btn-refill { background: #3498db; color: white; }
        .btn-draw { background: #ff7675; color: white; font-size: 20px; width: 100%; margin-top: 15px; }
        .btn-delete { background: #ff4757; color: white; padding: 5px 8px; font-size: 11px; }
        .btn:disabled { background: #ccc; }
        
        .history-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border-top: 1px solid #eee; }
        .history-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 13px; }
        .history-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; border: 1px solid #ccc; }
        
        #result-text { margin-top: 20px; font-size: 20px; font-weight: bold; min-height: 1.5em; color: #2d3436; }
        .stock-label { font-size: 10px; color: #888; display: block; }
    </style>
</head>
<body>

    <h1>æ‰‹å‹•è£œå……ã‚¬ãƒ©ã‚¬ãƒ©ãƒãƒ³</h1>

    <div class="main-layout">
        <div class="machine-area">
            <div class="machine-container">
                <div id="machine" class="machine-body"></div>
                <div class="exit"></div>
                <div id="ball" class="ball"></div>
            </div>
            <div id="result-text">æº–å‚™ãŒã§ãã¾ã—ãŸï¼</div>
            <button id="draw-btn" class="btn btn-draw" onclick="startLottery()">ã¾ã‚ã™ï¼</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <h3 style="margin:0;">è¨­å®šã¨è£œå……</h3>
                <div>
                    <button class="btn btn-add" onclick="addRow()">ï¼‹è³è¿½åŠ </button>
                    <button class="btn btn-refill" onclick="refillAll()">ğŸ”„ ç‰ã‚’è£œå……</button>
                </div>
            </div>
            <table id="settings-table">
                <thead>
                    <tr>
                        <th>è‰²</th>
                        <th>è³ã®åå‰</th>
                        <th>åˆæœŸæ•°</th>
                        <th>ç¾åœ¨ã®åœ¨åº«</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="settings-body"></tbody>
            </table>
            <p style="font-size:11px; color:#666;">â€»åˆæœŸæ•°ï¼šè£œå……ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«ã“ã®æ•°ã«æˆ»ã‚Šã¾ã™ã€‚</p>
        </div>

        <div class="card" style="width:300px;">
            <h3>æŠ½é¸å±¥æ­´</h3>
            <ul id="history-list" class="history-list"></ul>
            <button class="btn" style="font-size:11px; margin-top:10px; background:#eee;" onclick="clearHistory()">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <script>
        window.onload = () => {
            loadSettings();
            loadHistory();
        };

        // --- è¨­å®šã¨ä¿å­˜ ---
        function saveSettings() {
            const rows = document.querySelectorAll('#settings-table tbody tr');
            const settings = Array.from(rows).map(row => {
                const inputs = row.querySelectorAll('input');
                return { 
                    color: inputs[0].value, 
                    name: inputs[1].value, 
                    init: inputs[2].value, 
                    stock: inputs[3].value 
                };
            });
            localStorage.setItem('garagara_v2_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('garagara_v2_settings');
            const data = saved ? JSON.parse(saved) : [
                { color: '#ffd700', name: 'é‡‘è³', init: '1', stock: '1' },
                { color: '#ffffff', name: 'ãƒã‚ºãƒ¬', init: '10', stock: '10' }
            ];
            const tbody = document.getElementById('settings-body');
            tbody.innerHTML = '';
            data.forEach(item => addRow(item.color, item.name, item.init, item.stock));
        }

        function addRow(color="#3498db", name="æ–°è³å“", init="5", stock="5") {
            const tbody = document.getElementById('settings-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="color" value="${color}" onchange="saveSettings()"></td>
                <td><input type="text" value="${name}" onchange="saveSettings()"></td>
                <td><input type="number" value="${init}" min="0" onchange="saveSettings()"></td>
                <td style="font-weight:bold;"><input type="number" value="${stock}" min="0" onchange="saveSettings()"></td>
                <td><button class="btn btn-delete" onclick="this.closest('tr').remove(); saveSettings();">æ¶ˆã™</button></td>
            `;
            tbody.appendChild(row);
            saveSettings();
        }

        // --- è£œå……æ©Ÿèƒ½ ---
        function refillAll() {
            if(!confirm('ã™ã¹ã¦ã®åœ¨åº«ã‚’åˆæœŸæ•°ã¾ã§è£œå……ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const rows = document.querySelectorAll('#settings-table tbody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const initValue = inputs[2].value; // åˆæœŸæ•°
                inputs[3].value = initValue;      // ç¾åœ¨ã®åœ¨åº«ã«åæ˜ 
            });
            saveSettings();
            document.getElementById('result-text').innerText = "ç‰ã‚’è£œå……ã—ã¾ã—ãŸï¼";
        }

        // --- å±¥æ­´æ©Ÿèƒ½ ---
        function addHistory(prize) {
            const saved = JSON.parse(localStorage.getItem('garagara_v2_history') || '[]');
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            saved.unshift({ time: timeStr, color: prize.color, name: prize.name });
            localStorage.setItem('garagara_v2_history', JSON.stringify(saved.slice(0, 50)));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const saved = JSON.parse(localStorage.getItem('garagara_v2_history') || '[]');
            list.innerHTML = saved.map(item => `
                <li class="history-item">
                    <span style="color:#888; font-size:11px; width:40px;">${item.time}</span>
                    <div class="history-dot" style="background-color: ${item.color}"></div>
                    <span>${item.name}</span>
                </li>
            `).join('');
        }

        function loadHistory() { renderHistory(); }
        function clearHistory() { localStorage.removeItem('garagara_v2_history'); renderHistory(); }

        // --- æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ ---
        function startLottery() {
            const btn = document.getElementById('draw-btn');
            const machine = document.getElementById('machine');
            const ball = document.getElementById('ball');
            const resultText = document.getElementById('result-text');

            const rows = document.querySelectorAll('#settings-table tbody tr');
            let prizes = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const stock = parseInt(inputs[3].value);
                if (stock > 0) {
                    prizes.push({ color: inputs[0].value, name: inputs[1].value, stock: stock, inputElement: inputs[3] });
                }
            });

            if (prizes.length === 0) {
                resultText.innerText = "ç‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼è£œå……ã—ã¦ãã ã•ã„ã€‚";
                return;
            }

            btn.disabled = true;
            resultText.innerText = "æŠ½é¸ä¸­...";
            machine.classList.remove('rotating');
            ball.classList.remove('ball-drop');
            void machine.offsetWidth;
            machine.classList.add('rotating');

            const totalStock = prizes.reduce((sum, p) => sum + p.stock, 0);
            let random = Math.floor(Math.random() * totalStock);
            let selected = prizes.find(p => (random -= p.stock) < 0);

            setTimeout(() => {
                ball.style.backgroundColor = selected.color;
                ball.classList.add('ball-drop');
                setTimeout(() => {
                    resultText.innerText = `å‡ºãŸï¼ã€${selected.name}ã€‘`;
                    selected.inputElement.value = selected.stock - 1;
                    saveSettings();
                    addHistory(selected);
                    btn.disabled = false;
                }, 600);
            }, 1200);
        }
    </script>
</body>
</html>